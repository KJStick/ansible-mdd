- name: Run Checks
  include_role:
    name: ciscops.mdd.check
    tasks_from: find_schema
  vars:
    schema_name: "{{ check_table[check_name].schema }}"

- name: Check to make sure that we found a schema
  assert:
    that:
      - schema_file is defined
      - schema_file
    fail_msg: "{{ check_table[check_name].schema }} cannot be found"
    success_msg: "Found {{ schema_file }}"

- name: Run Command
  include_role:
    name: ciscops.mdd.nso
    tasks_from: exec_command
  vars:
    nso_exec_command: "{{ check_table[check_name].command }}"

- name: Parsing output
  set_fact:
    parsed_output: "{{ nso_command_output | cisco.pyats.pyats_parser(check_table[check_name].command, 'iosxe') }}"

- block:
  - name: Validate data
    datavalidation:
      data: "{{ parsed_output }}"
      schema: "{{ lookup('file', schema_file) | from_yaml }}"
    register: validation_output
  rescue:
  - set_fact:
      failed_checks: "{{ (failed_checks | default([])) + [check_name] }}"