- hosts: ios
  connection: local
  gather_facts: no
  vars:
    netbox_host: "{{ lookup('env', 'NETBOX_HOST') | default (hostvars['netbox'].ansible_host) }}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    netbox_site: 'default'
  tasks:
    - block:
      - debug:
          msg: "{{ netbox_host }}: {{ netbox_token }}"
          
      - name: Set the mgmt interface
        debug:
          msg: "{{ inventory_hostname }}: {{ ansible_host_interface }}, {{ ansible_host }}"

      - name: Add IP address
        netbox.netbox.netbox_ip_address:
          netbox_url: "https://{{ netbox_host }}"
          netbox_token: "{{ netbox_token }}"
          data:
            address: "{{ ansible_host }}"
            assigned_object:
              device: "{{ inventory_hostname }}"
              name: "{{ ansible_host_interface }}"
            status: active
          state: present
          validate_certs: no

      - name: Update Mgmt Address
        netbox.netbox.netbox_device:
          netbox_url: "https://{{ netbox_host }}"
          netbox_token: "{{ netbox_token }}"
          data:
            name: "{{ inventory_hostname }}"
            primary_ip4: "{{ ansible_host }}"
          state: present
          validate_certs: false
      when: ansible_host_interface is defined