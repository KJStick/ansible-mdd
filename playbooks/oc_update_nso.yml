- name: Push OC Interfaces to NSO
  hosts: all
  connection: local
  gather_facts: no
  vars:
    nso_hostname: "{{ groups.nso_hosts | first }}"
    nso_host: "{{ hostvars[nso_hostname].ansible_host }}"
    dry_run: true
    models: all
  tasks:
    - set_fact:
        nso_host: "{{ custom_fields.nso_host }}"
      when: custom_fields.nso_host is defined

    - block:
      - name: Get OC Data
        include_role:
          name: ciscops.mdd.oc
          tasks_from: "{{ models }}"

    # - debug:
    #     var: mdd_data

    # - copy:
    #     content: "{{ mdd_data | to_nice_yaml }}"
    #     dest: "/tmp/{{ inventory_hostname}}_debug.yaml"

    - name: Update System Information
      uri:
        url: "http://{{ nso_host }}:8080/restconf/data/tailf-ncs:devices/device={{ inventory_hostname }}/mdd:openconfig{{ '?dry-run=native' if dry_run | bool else '' }}" 
        url_username: admin
        url_password: admin
        force_basic_auth: yes
        validate_certs: no
        status_code: [200,201,204]
        method: PUT
        headers: "{
          'Content-Type': 'application/yang-data+json',
          'Accept': 'application/yang-data+json'}"
        body_format: json
        body: 
          "{{ mdd_data }}"
      register: results

    - debug:
        var: results.json
      when: "'json' in results"
